<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Water Sort Puzzle - Online Game </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #FFD700;
            --success: #4CAF50;
            --danger: #FF6B6B;
            --info: #17a2b8;
            --dark: #1a1a2e;
            --light: #f8f9fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* Login Screen */
        .login-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .login-icon {
            font-size: 5rem;
            color: var(--accent);
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .login-message {
            font-size: 1.2rem;
            margin-bottom: 30px;
            color: rgba(255, 255, 255, 0.9);
            padding: 0 10px;
        }

        /* Game Container */
        .game-container {
            display: none;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Game Board */
        .game-board {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            min-height: 250px;
        }

        .tube {
            width: 70px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px 5px 10px 10px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            padding: 5px;
            position: relative;
            transition: all 0.3s ease;
        }

        .tube.selected {
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--accent);
            transform: translateY(-5px);
        }

        .tube.completed::after {
            content: '‚úì';
            position: absolute;
            bottom: -15px;
            right: -15px;
            background: var(--success);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .water {
            height: 40px;
            border-radius: 5px;
            margin: 2px 0;
            transition: all 0.3s ease;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .water::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30%;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 0 0 5px 5px;
        }

        /* Controls */
        .controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            color: white;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #2E7D32);
        }

        .btn-warning {
            background: linear-gradient(45deg, #FF9800, #F57C00);
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--danger), #D32F2F);
        }

        .btn-info {
            background: linear-gradient(45deg, var(--info), #138496);
        }

        /* Level Selector */
        .level-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
        }

        .level-btn {
            aspect-ratio: 1;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 1.2rem;
        }

        .level-btn.active {
            background: var(--success);
            border-color: var(--success);
            box-shadow: 0 0 15px var(--success);
        }

        .level-btn.completed {
            background: rgba(76, 175, 80, 0.3);
            border-color: var(--success);
        }

        .level-btn.locked {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Ads Section */
        .ads-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .ad-btn {
            background: linear-gradient(45deg, #9C27B0, #673AB7);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .ad-btn:active {
            transform: scale(0.98);
        }

        /* Unity Ads Button */
        .unity-ad-btn {
            background: linear-gradient(45deg, #00BCD4, #0097A7);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px auto;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            width: 100%;
        }

        .unity-ad-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 188, 212, 0.4);
        }

        /* Start Button */
        .start-btn {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            margin: 10px 0;
            width: 100%;
        }

        .start-btn:active {
            transform: scale(0.95);
        }

        /* Already Completed Indicator */
        .already-completed {
            background: rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #FFD700;
            border: 2px solid #FFD700;
        }


        .apk-item {
    margin-bottom: 20px;
}

.apk-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.btn-download {
    flex: 1;
    text-align: center;
    padding: 12px 14px;
    border-radius: 10px;
    background: linear-gradient(90deg, #00d4ff, #00a2ff);
    color: #000;
    font-weight: 600;
    text-decoration: none;
    transition: 0.3s;
}

.btn-download.final {
    background: linear-gradient(90deg, #00ffaa, #00cc88);
}

.btn-copy {
    padding: 12px 14px;
    border-radius: 10px;
    background: rgba(255,255,255,0.15);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.25);
    cursor: pointer;
    font-weight: 600;
    transition: 0.3s;
}

.btn-download:hover,
.btn-copy:hover {
    transform: scale(1.05);
}


        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 25px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Victory Modal */
        .victory-modal .modal-content {
            text-align: center;
        }

        .victory-icon {
            font-size: 4rem;
            color: var(--accent);
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }

        .coins-earned {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.5rem;
            margin: 20px 0;
            color: var(--accent);
            font-weight: 700;
        }

        /* Ads Modal */
        .ads-modal .modal-content {
            text-align: center;
        }

        .ad-content {
            height: 200px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }

        .countdown {
            font-size: 3rem;
            font-weight: 700;
            margin: 20px 0;
            color: var(--accent);
        }

        .social-box {
    margin-top: 20px;
    text-align: center;
}

.insta-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 14px 22px;
    border-radius: 50px;
    text-decoration: none;
    font-weight: 600;
    font-size: 1rem;
    color: #fff;
    background: linear-gradient(45deg, #f58529, #dd2a7b, #8134af, #515bd4);
    box-shadow: 0 6px 18px rgba(221, 42, 123, 0.4);
    transition: all 0.3s ease;
}

.insta-btn i {
    font-size: 1.4rem;
}

.insta-btn .insta-id {
    font-size: 0.85rem;
    opacity: 0.9;
}

.insta-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 10px 25px rgba(221, 42, 123, 0.6);
}


        /* User Profile */
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .input-group {
            margin-bottom: 15px;
        }

        input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .error-message {
            color: var(--danger);
            font-size: 0.9rem;
            margin: 10px 0;
            min-height: 20px;
        }

        .success-message {
            color: var(--success);
            font-size: 0.9rem;
            margin: 10px 0;
            min-height: 20px;
        }

        /* Color Indicator */
        .color-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .color-box {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        /* Responsive */
        @media (max-width: 480px) {
            .tube {
                width: 60px;
                height: 180px;
            }
            
            .water {
                height: 35px;
            }
            
            .level-selector {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div class="login-screen" id="loginScreen">
            <div class="login-icon">
                <i class="fas fa-lock"></i>
            </div>
            <h1><i class="fas fa-water"></i> Water Sort Puzzle</h1>
            <p class="subtitle">Login Required to Play</p>
            
            <div class="login-message">
                <p>Please login to access the game. No guest access available.</p>
                <p><strong>Your progress will be saved online!</strong></p>
            </div>
            
            <div class="controls" style="grid-template-columns: 1fr; max-width: 300px; margin: 0 auto;">
                <button class="btn btn-primary" onclick="showLogin()">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <button class="btn btn-success" onclick="showSignup()">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>
            </div>
        </div>

        <script>
function copyLink(link) {
    navigator.clipboard.writeText(link).then(() => {
        alert("Link copied successfully!");
    });
}
</script>


        <!-- Game Container -->
        <div class="game-container" id="gameContainer">
            <!-- Header -->
            <div class="header">
                <h1><i class="fas fa-water"></i> Water Sort Puzzle  </h1>
                <p class="subtitle">Coin X</p>
            </div>

            <!-- Stats -->
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-value" id="moves">0</div>
                    <div class="stat-label">Moves</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="coins">0</div>
                    <div class="stat-label">Coins</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="level">1</div>
                    <div class="stat-label">Level</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="hints">5</div>
                    <div class="stat-label">Hints</div>
                </div>
            </div>

            <!-- Color Indicator -->
            <div class="color-indicator" id="colorIndicator">
                <!-- Colors will be added here -->
            </div>

            <!-- Game Board -->
            <div class="game-board" id="gameBoard">
                <!-- Tubes will be added here -->
            </div>

            <!-- Already Completed Message -->
            <div class="already-completed" id="alreadyCompleted" style="display: none;">
                <i class="fas fa-check-circle"></i> You have already completed this level!
            </div>

            <!-- ‚úÖ START Button -->
            <button class="start-btn" onclick="showInterstitial()">
                <i class="fas fa-play"></i> START LEVEL
            </button>

            <!-- Controls -->
            <div class="controls">
                <button class="btn btn-warning" onclick="giveHint()">
                    <i class="fas fa-lightbulb"></i> Hint (<span id="hintsCount">5</span>)
                </button>
                <button class="btn btn-primary" onclick="undoMove()">
                    <i class="fas fa-undo"></i> Undo (<span id="undoCount">3</span>)
                </button>
                <button class="btn btn-danger" onclick="restartLevel()">
                    <i class="fas fa-redo"></i> Restart
                </button>
                <!-- CHANGED: Solve ki jagah Rules -->
                <button class="btn btn-info" onclick="showRules()">
                    <i class="fas fa-book"></i> Rules
                </button>
            </div>

            <!-- Level Selector -->
            <div class="level-selector" id="levelSelector">
                <!-- Levels will be added here -->
            </div>

            <!-- Ads Section -->
            <div class="ads-section">
                <h3><i class="fas fa-gem"></i> Earn Rewards</h3>
                
                <!-- ‚úÖ Unity Ads Buttons -->
                <button class="unity-ad-btn" onclick="showRewarded('hints')">
                    <i class="fas fa-ad"></i> Unity Ad for 3 Hints
                </button>
                
                <button class="unity-ad-btn" onclick="showRewarded('undo')">
                    <i class="fas fa-ad"></i> Unity Ad for 3 Undo
                </button>
            </div>

            <!-- User Section -->
            <div class="user-info" onclick="showUserProfile()">
                <div class="user-avatar" id="userAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <h3 id="userName">Loading...</h3>
                    <p id="userEmail">Login required</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Victory Modal -->
    <!-- Victory Modal -->
<div class="modal" id="victoryModal">
    <div class="modal-content victory-modal">
        <div class="modal-header">
            <h2 class="modal-title">üéâ Level Complete!</h2>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="victory-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <p>You sorted all colors perfectly!</p>
            
            <div class="stats" style="background: transparent; margin: 20px 0;">
                <div class="stat-box">
                    <div class="stat-value" id="finalMoves">0</div>
                    <div class="stat-label">Moves</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="finalTime">00:00</div>
                    <div class="stat-label">Time</div>
                </div>
            </div>

            <div class="coins-earned" id="coinsEarnedSection">
                <i class="fas fa-coins"></i>
                <span>+2 Coins Earned!</span>
            </div>

            <!-- Already Completed Message in Modal -->
            <div class="already-completed" id="alreadyCompletedModal" style="display: none; margin: 20px 0;">
                <i class="fas fa-info-circle"></i> You already completed this level before. No coins earned.
            </div>

            <!-- CHANGE: Sirf Unity Ad ka button rahega -->
            <div class="controls" style="grid-template-columns: 1fr; gap: 10px; margin-top: 20px;">
                <button class="unity-ad-btn" onclick="showRewarded('nextLevel')">
                    <i class="fas fa-ad"></i> Next Level
                </button>
                
                <!-- Optional: Close button agar aap chahein -->
                <button class="btn btn-primary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>
             

  <!-- Rules Modal -->
<div class="modal" id="rulesModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-book"></i> Game Rules</h2>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>

        <!-- SCROLL ENABLED BODY -->
        <div class="modal-body" style="max-height:70vh; overflow-y:auto;">

            <div style="text-align:left; padding:10px;">

                <h3>üéÆ Game & Coin Rules:</h3>
                <ol style="margin-left:20px; margin-bottom:20px;">

                    <li>Coins will <strong>not be counted</strong> if ads are skipped.</li>

                    <li>
                        A maximum of <strong>60 coins per day</strong> will be counted.
                        Coins earned beyond this limit will not be counted.
                    </li>

                    <li>Game levels will reset every day at <strong>3:00 AM (morning)</strong>.</li>

                    <li>
                        Completing <strong>1700 coins</strong> is mandatory to become
                        <strong>eligible for the final match</strong>.
                    </li>

                    <li>
                        Coins will be counted only until <strong>2:00 AM (morning)</strong>.
                        Coins earned after 2:00 AM will not be counted.
                    </li>

                    <li>Users will receive a <strong>daily coin summary email</strong>.</li>

                    <li>
                        Only <strong>eligible users</strong> will be allowed to participate in the final match.
                    </li>

                    <li>
                        The final match is <strong>skill-based</strong>, and rewards will depend on
                        performance in the final match.
                    </li>

  <li class="apk-item">
    <strong>Original Game APK (Practice & Coin Collection)</strong>

    <div class="apk-actions">
        <button class="btn-copy"
            onclick="copyLink('https://github.com/Coin-X-official/coin_X_/releases/download/Coin_X/app-debug.apk')">
            <i class="fas fa-copy"></i> Copy APK Link
        </button>
    </div>
</li>

<li class="apk-item">
    <strong>Final Match Game APK (Final Match Play)</strong>

    <div class="apk-actions">
        <button class="btn-copy final"
            onclick="copyLink('https://github.com/Coin-X-official/coin_X/releases/download/Coin_X_least/app-debug.apk')">
            <i class="fas fa-copy"></i> Copy Final APK Link
        </button>
    </div>
</li>



  


                </ol>

                <h3>‚öñÔ∏è Legal Disclaimer:</h3>
                <ul style="margin-left:20px; margin-bottom:20px;">
                    <li>This is a <strong>skill-based game</strong>.</li>
                    <li>Completing coins only makes the user <strong>eligible</strong> for the final match.</li>
                    <li>Rewards are <strong>promotional and limited</strong>.</li>
                    <li>Rewards are <strong>not guaranteed</strong> for every user.</li>
                    <li><strong>Admin‚Äôs decision will be final</strong>.</li>
                    <li><strong>Terms & Conditions apply</strong>.</li>
                </ul>

   


                <div class="already-completed" style="margin-top:15px;">
                    <i class="fas fa-lightbulb"></i>
                    <strong>Note:</strong> Any misuse, automation, or unfair activity may result in disqualification.
                </div>
<div class="social-box">
    <i class="fa-brands fa-instagram insta-icon"></i>
    <span class="insta-id-text">@official_coin_x</span>
</div>

            </div>

            <div class="controls" style="grid-template-columns:1fr; margin-top:20px;">
                <button class="btn btn-success" onclick="closeModal()">
                    <i class="fas fa-check"></i> Got It!
                </button>
            </div>

        </div>
    </div>
</div>



    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Login</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <input type="email" id="loginEmail" placeholder="Email">
                </div>
                <div class="input-group">
                    <input type="password" id="loginPassword" placeholder="Password">
                </div>
                <div class="error-message" id="loginError"></div>
                <button class="btn btn-primary" onclick="login()" style="width: 100%;">Login</button>
                <button class="btn btn-success" onclick="showSignup()" style="width: 100%; margin-top: 10px;">
                    Create New Account
                </button>
            </div>
        </div>
    </div>

    <!-- Signup Modal -->
    <div class="modal" id="signupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Sign Up</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <input type="text" id="signupName" placeholder="Username">
                </div>
                <div class="input-group">
                    <input type="email" id="signupEmail" placeholder="Email">
                </div>
                <div class="input-group">
                    <input type="password" id="signupPassword" placeholder="Password">
                </div>
                <div class="error-message" id="signupError"></div>
                <div class="success-message" id="signupSuccess"></div>
                <button class="btn btn-success" onclick="signup()" style="width: 100%;">Sign Up</button>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Player Profile</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="user-info">
                    <div class="user-avatar" id="profileAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h3 id="profileName">Loading...</h3>
                        <p id="profileEmail">Loading...</p>
                    </div>
                </div>
                
                <div class="stats" style="background: transparent;">
                    <div class="stat-box">
                        <div class="stat-value" id="profileCoins">0</div>
                        <div class="stat-label">Coins</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="profileLevels">0</div>
                        <div class="stat-label">Levels</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="profileHints">0</div>
                        <div class="stat-label">Hints</div>
                    </div>
                </div>
                
                <div class="controls" style="grid-template-columns: 1fr; margin-top: 20px;">
                    <button class="btn btn-danger" onclick="logout()" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚úÖ GLOBAL ADS FUNCTIONS -->
    <script>
        let pendingRewardType = null;

        function onInterstitialAdComplete() {
            console.log("üé¨ Interstitial ad completed from Android");
            
            try {
                if (typeof window.gameState !== 'undefined' && !window.gameState.currentLevelStarted) {
                    window.gameState.currentLevelStarted = true;
                    const startButton = document.querySelector('.start-btn');
                    if (startButton) {
                        startButton.disabled = true;
                        startButton.innerHTML = '<i class="fas fa-play"></i> LEVEL STARTED';
                        startButton.style.background = 'linear-gradient(45deg, #4CAF50, #2E7D32)';
                    }
                    
                    if (window.gameState.completedLevels.has(window.gameState.currentLevel)) {
                        const alreadyCompleted = document.getElementById('alreadyCompleted');
                        if (alreadyCompleted) alreadyCompleted.style.display = 'block';
                    }
                    
                    alert("üéâ Level " + window.gameState.currentLevel + " Started!");
                    
                    if (typeof window.enableGameControls !== 'undefined') {
                        window.enableGameControls();
                    }
                }
            } catch (error) {
                console.error("Error in onInterstitialAdComplete:", error);
                alert("Game started!");
            }
        }

        function onRewardedAdComplete() {
            console.log("üé¨ Rewarded ad completed from Android");
            
            try {
                if (typeof pendingRewardType !== 'undefined' && pendingRewardType) {
                    console.log("üéÅ Giving reward:", pendingRewardType);
                    
                    if (typeof window.giveReward !== 'undefined') {
                        window.giveReward(pendingRewardType);
                    }
                }
            } catch (error) {
                console.error("Error in onRewardedAdComplete:", error);
                alert("Reward received!");
            }
        }


        

        function giveReward(rewardType) {
            if (typeof window.gameState === 'undefined') return;
            
            switch(rewardType) {
                case "hints":
                    window.gameState.hints += 3;
                    alert("üéâ +3 Hints added!");
                    break;
                case "undo":
                    window.gameState.undoCount += 3;
                    alert("üéâ +3 Undo added!");
                    break;
                case "nextLevel":
                    if (window.gameState.currentLevel < 30) {
                        window.gameState.currentLevel++;
                        window.gameState.currentLevelStarted = false;
                        if (typeof window.loadLevel !== 'undefined') {
                            window.loadLevel(window.gameState.currentLevel);
                        }
                        if (typeof window.closeModal !== 'undefined') {
                            window.closeModal();
                        }
                        alert("üéâ Moving to next level!");
                    } else {
                        alert("üéâ You've completed all levels!");
                    }
                    break;
                case "coins":
                    window.gameState.coins += 10;
                    alert("üéâ +10 Coins added!");
                    break;
            }
            
            if (typeof window.updateDisplay !== 'undefined') window.updateDisplay();
            if (typeof window.saveGameData !== 'undefined') window.saveGameData();
        }

        function showInterstitial() {
            console.log("showInterstitial called");
            if (window.Android) {
                console.log("Calling Android.showInterstitialAd()");
                Android.showInterstitialAd();
            } else {
                console.log("Not in Android App - Browser test");
                onInterstitialAdComplete();
            }
        }

        function showRewarded(type) {
            console.log("showRewarded called with type:", type);
            pendingRewardType = type;
            
            if (window.Android) {
                console.log("Calling Android.showRewardedAd()");
                Android.showRewardedAd();
            } else {
                console.log("Not in Android App - Browser test");
                onRewardedAdComplete();
            }
        }

        function addRewardCoins(amount) {
            if (typeof window.gameState !== 'undefined') {
                window.gameState.coins += amount;
                if (typeof window.updateDisplay !== 'undefined') window.updateDisplay();
                if (typeof window.saveGameData !== 'undefined') window.saveGameData();
                alert("üéâ +" + amount + " Coins added!");
            }
        }

        // Make functions globally available
        window.onInterstitialAdComplete = onInterstitialAdComplete;
        window.onRewardedAdComplete = onRewardedAdComplete;
        window.giveReward = giveReward;
        window.showInterstitial = showInterstitial;
        window.showRewarded = showRewarded;
        window.addRewardCoins = addRewardCoins;
    </script>

    <!-- GAME LOGIC SCRIPT -->
    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            updateDoc 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyB2_aqR6igEYXKSk7eiO8uD88UVsy75tdU",
            authDomain: "animeversemines.firebaseapp.com",
            projectId: "animeversemines",
            storageBucket: "animeversemines.firebasestorage.app",
            messagingSenderId: "58116558082",
            appId: "1:58116558082:web:1c1a03dd29957efc0bc61b",
            measurementId: "G-JKMH6TCLKD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // PREDEFINED LEVELS DATA (30 levels)
        const predefinedLevels = {
            1: {
                bottles: [
                    [1, 1, 2, 2],
                    [2, 2, 1, 1],
                    [0, 0, 0, 0]
                ],
                colors: 2
            },
            2: {
                bottles: [
                    [1, 2, 1, 2],
                    [2, 1, 2, 1],
                    [0, 0, 0, 0]
                ],
                colors: 2
            },
            3: {
                bottles: [
                    [1, 1, 2, 3],
                    [2, 3, 1, 2],
                    [3, 2, 3, 1],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            4: {
                bottles: [
                    [1, 2, 3, 1],
                    [2, 3, 1, 2],
                    [3, 1, 2, 3],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            5: {
                bottles: [
                    [1, 1, 2, 3],
                    [3, 2, 1, 2],
                    [2, 3, 3, 1],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            6: {
                bottles: [
                    [1, 2, 3, 1],
                    [1, 3, 2, 2],
                    [3, 2, 1, 3],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            7: {
                bottles: [
                    [1, 3, 1, 2],
                    [2, 1, 3, 3],
                    [3, 2, 2, 1],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            8: {
                bottles: [
                    [1, 2, 1, 3],
                    [2, 3, 2, 1],
                    [3, 1, 3, 2],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            9: {
                bottles: [
                    [1, 1, 2, 2],
                    [2, 3, 1, 3],
                    [3, 3, 1, 2],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            10: {
                bottles: [
                    [1, 3, 2, 3],
                    [2, 1, 3, 1],
                    [3, 2, 1, 2],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            11: {
                bottles: [
                    [1, 2, 1, 2],
                    [3, 1, 3, 2],
                    [2, 3, 3, 1],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            12: {
                bottles: [
                    [1, 3, 1, 2],
                    [1, 2, 3, 3],
                    [2, 2, 3, 1],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            13: {
                bottles: [
                    [1, 2, 3, 1],
                    [3, 2, 1, 2],
                    [1, 3, 2, 3],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            14: {
                bottles: [
                    [1, 3, 2, 1],
                    [2, 1, 3, 2],
                    [3, 2, 1, 3],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            15: {
                bottles: [
                    [1, 2, 1, 3],
                    [3, 1, 2, 2],
                    [2, 3, 3, 1],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            16: {
                bottles: [
                    [1, 2, 3, 1],
                    [2, 1, 3, 2],
                    [3, 2, 1, 3],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            17: {
                bottles: [
                    [1, 3, 1, 2],
                    [3, 2, 1, 3],
                    [2, 1, 2, 3],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            18: {
                bottles: [
                    [1, 1, 2, 3],
                    [2, 2, 1, 3],
                    [3, 3, 2, 1],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            19: {
                bottles: [
                    [1, 2, 2, 3],
                    [3, 1, 1, 2],
                    [2, 3, 3, 1],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            20: {
                bottles: [
                    [1, 3, 2, 2],
                    [2, 1, 3, 3],
                    [3, 2, 1, 1],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            21: {
                bottles: [
                    [1, 2, 1, 2],
                    [3, 3, 2, 1],
                    [2, 1, 3, 3],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            22: {
                bottles: [
                    [1, 3, 2, 1],
                    [3, 1, 2, 3],
                    [2, 2, 3, 1],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            23: {
                bottles: [
                    [1, 2, 3, 3],
                    [2, 3, 1, 1],
                    [3, 1, 2, 2],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            24: {
                bottles: [
                    [1, 1, 3, 2],
                    [2, 3, 2, 1],
                    [3, 2, 1, 3],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            25: {
                bottles: [
                    [1, 2, 2, 1],
                    [3, 1, 3, 2],
                    [2, 3, 1, 3],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            26: {
                bottles: [
                    [1, 3, 1, 2],
                    [3, 2, 3, 1],
                    [2, 1, 2, 3],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            27: {
                bottles: [
                    [1, 2, 3, 1],
                    [2, 3, 1, 3],
                    [3, 1, 2, 2],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            28: {
                bottles: [
                    [1, 1, 2, 2],
                    [3, 3, 1, 3],
                    [2, 1, 3, 2],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            29: {
                bottles: [
                    [1, 3, 2, 3],
                    [2, 1, 3, 1],
                    [3, 2, 1, 2],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0]
                ],
                colors: 3
            },
            30: {
                bottles: [
                    [1, 2, 1, 3],
                    [2, 3, 2, 1],
                    [3, 1, 3, 2],
                    [1, 2, 3, 1],
                    [0, 0, 0, 0],
                    [0, 0, 0, 0]
                ],
                colors: 3
            }
        };

        // Color Palette
        const colorPalette = [
            '#FF6B6B', // 1 - Red
            '#4ECDC4', // 2 - Turquoise
            '#FFD166', // 3 - Yellow
            '#06D6A0', // 4 - Green
            '#118AB2', // 5 - Blue
            '#9D4EDD', // 6 - Purple
            '#FF9E00', // 7 - Orange
            '#7209B7', // 8 - Violet
            '#3A86FF', // 9 - Light Blue
            '#FB5607', // 10 - Bright Orange
            '#38B000', // 11 - Lime Green
            '#FF0054'  // 12 - Pink
        ];

        // Game State
        let gameState = {
            currentLevel: 1,
            moves: 0,
            coins: 0,
            hints: 5,
            timer: 0,
            timerInterval: null,
            selectedTube: null,
            bottles: [],
            moveHistory: [],
            completedLevels: new Set(),
            totalCoinsEarned: 0,
            undoCount: 3,
            gameStarted: false,
            currentLevelStarted: false
        };

        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const gameContainer = document.getElementById('gameContainer');
        const gameBoard = document.getElementById('gameBoard');
        const movesElement = document.getElementById('moves');
        const coinsElement = document.getElementById('coins');
        const levelElement = document.getElementById('level');
        const hintsElement = document.getElementById('hints');
        const levelSelector = document.getElementById('levelSelector');
        const colorIndicator = document.getElementById('colorIndicator');
        const startButton = document.querySelector('.start-btn');
        const alreadyCompleted = document.getElementById('alreadyCompleted');
        const alreadyCompletedModal = document.getElementById('alreadyCompletedModal');
        const coinsEarnedSection = document.getElementById('coinsEarnedSection');
        const hintsCountElement = document.getElementById('hintsCount');
        const undoCountElement = document.getElementById('undoCount');

        // ‚úÖ SHOW/HIDE SCREENS BASED ON LOGIN
        function showLoginScreen() {
            loginScreen.style.display = 'block';
            gameContainer.style.display = 'none';
        }

        function showGameScreen() {
            loginScreen.style.display = 'none';
            gameContainer.style.display = 'block';
        }

        // ‚úÖ Game controls enable karna
        function enableGameControls() {
            const tubes = document.querySelectorAll('.tube');
            tubes.forEach(tube => {
                tube.style.pointerEvents = 'auto';
                tube.style.cursor = 'pointer';
            });
            
            document.querySelector('.controls').style.opacity = '1';
            document.querySelector('.controls').style.pointerEvents = 'auto';
        }

        // ‚úÖ Game controls disable karna
        function disableGameControls() {
            const tubes = document.querySelectorAll('.tube');
            tubes.forEach(tube => {
                tube.style.pointerEvents = 'none';
                tube.style.cursor = 'default';
            });
            
            document.querySelector('.controls').style.opacity = '0.5';
            document.querySelector('.controls').style.pointerEvents = 'none';
        }

        // ‚úÖ CHECK IF USER IS LOGGED IN
        function checkLogin() {
            const user = auth.currentUser;
            if (!user) {
                alert("Please login first!");
                showLogin();
                return false;
            }
            return true;
        }

        // Initialize Game
        function initGame() {
            const user = auth.currentUser;
            if (user) {
                loadUserDataFromFirebase();
            } else {
                showLoginScreen();
            }
        }

        function loadGameDataFromFirebase(data) {
            if (data && data.gameData) {
                gameState.coins = data.gameData.coins || 0;
                gameState.completedLevels = new Set(data.gameData.completedLevels || []);
                gameState.totalCoinsEarned = data.gameData.totalCoinsEarned || 0;
                gameState.currentLevel = data.gameData.currentLevel || 1;
                gameState.hints = data.gameData.hints || 5;
                gameState.undoCount = data.gameData.undoCount || 3;
                gameState.gameStarted = data.gameData.gameStarted || false;
                gameState.currentLevelStarted = data.gameData.currentLevelStarted || false;
                
                updateDisplay();
                createLevelSelector();
                loadLevel(gameState.currentLevel);
                startTimer();
            }
        }

        async function saveGameData() {
            const user = auth.currentUser;
            if (!user) {
                alert("Cannot save: User not logged in!");
                return;
            }
            
            try {
                const userRef = doc(db, 'users', user.uid);
                await updateDoc(userRef, {
                    gameData: {
                        coins: gameState.coins,
                        completedLevels: Array.from(gameState.completedLevels),
                        totalCoinsEarned: gameState.totalCoinsEarned,
                        currentLevel: gameState.currentLevel,
                        hints: gameState.hints,
                        undoCount: gameState.undoCount,
                        gameStarted: gameState.gameStarted,
                        currentLevelStarted: gameState.currentLevelStarted
                    },
                    lastPlayed: new Date()
                });
            } catch (error) {
                console.error('Firebase save error:', error);
            }
        }

        function createLevelSelector() {
            levelSelector.innerHTML = '';
            for (let i = 1; i <= 30; i++) {
                const btn = document.createElement('div');
                btn.className = 'level-btn';
                
                if (i === gameState.currentLevel) {
                    btn.classList.add('active');
                }
                if (gameState.completedLevels.has(i)) {
                    btn.classList.add('completed');
                }
                if (i > 1 && !gameState.completedLevels.has(i - 1)) {
                    btn.classList.add('locked');
                }
                
                btn.textContent = i;
                
                if (!btn.classList.contains('locked')) {
                    btn.onclick = () => selectLevel(i);
                }
                
                levelSelector.appendChild(btn);
            }
        }

        function selectLevel(level) {
            if (!checkLogin()) return;
            
            if (level >= 1 && level <= 30) {
                if (level > 1 && !gameState.completedLevels.has(level - 1)) {
                    alert('Complete previous level first!');
                    return;
                }
                
                gameState.currentLevel = level;
                gameState.currentLevelStarted = false;
                loadLevel(level);
                document.querySelectorAll('.level-btn').forEach((btn, idx) => {
                    btn.classList.toggle('active', idx + 1 === level);
                });
            }
        }

        function loadLevel(level) {
            if (!checkLogin()) return;
            
            const levelData = predefinedLevels[level];
            
            gameState.selectedTube = null;
            gameState.moveHistory = [];
            gameState.moves = 0;
            gameState.timer = 0;
            gameState.currentLevelStarted = false;
            
            clearInterval(gameState.timerInterval);
            startTimer();
            
            gameState.bottles = JSON.parse(JSON.stringify(levelData.bottles));
            
            startButton.disabled = false;
            startButton.innerHTML = '<i class="fas fa-play"></i> START LEVEL ' + level;
            startButton.style.background = 'linear-gradient(45deg, #FF9800, #F57C00)';
            
            if (gameState.completedLevels.has(level)) {
                alreadyCompleted.style.display = 'block';
            } else {
                alreadyCompleted.style.display = 'none';
            }
            
            updateDisplay();
            updateColorIndicator(levelData.colors);
            renderBottles();
            
            disableGameControls();
        }

        function updateColorIndicator(colors) {
            colorIndicator.innerHTML = '';
            for (let i = 1; i <= colors; i++) {
                const colorBox = document.createElement('div');
                colorBox.className = 'color-box';
                colorBox.style.backgroundColor = colorPalette[i - 1];
                colorBox.textContent = i;
                colorIndicator.appendChild(colorBox);
            }
        }

        function renderBottles() {
            gameBoard.innerHTML = '';
            
            gameState.bottles.forEach((bottle, index) => {
                const bottleElement = document.createElement('div');
                bottleElement.className = 'tube';
                
                if (bottle.length === 4 && isBottleComplete(bottle)) {
                    bottleElement.classList.add('completed');
                }
                
                if (index === gameState.selectedTube) {
                    bottleElement.classList.add('selected');
                }
                
                bottleElement.onclick = () => selectBottle(index);
                
                bottle.forEach(colorCode => {
                    const waterElement = document.createElement('div');
                    waterElement.className = 'water';
                    
                    if (colorCode === 0) {
                        waterElement.style.visibility = 'hidden';
                    } else {
                        waterElement.style.backgroundColor = colorPalette[colorCode - 1];
                        waterElement.style.borderTop = `3px solid ${darkenColor(colorPalette[colorCode - 1], 30)}`;
                    }
                    
                    bottleElement.appendChild(waterElement);
                });
                
                gameBoard.appendChild(bottleElement);
            });
            
            if (!gameState.currentLevelStarted) {
                disableGameControls();
            }
        }

        function selectBottle(index) {
            if (!checkLogin()) return;
            
            if (!gameState.currentLevelStarted) {
                alert("Please start the level first by clicking START button!");
                return;
            }
            
            if (gameState.selectedTube === null) {
                if (hasColorInBottle(index)) {
                    gameState.selectedTube = index;
                    renderBottles();
                }
            } else {
                const fromBottle = gameState.selectedTube;
                const toBottle = index;
                
                if (fromBottle !== toBottle) {
                    if (canMoveWater(fromBottle, toBottle)) {
                        moveWater(fromBottle, toBottle);
                    } else {
                        if (isBottleFull(toBottle)) {
                            alert("‚ùå Bottle is full! Choose another bottle.");
                        } else if (!hasColorInBottle(fromBottle)) {
                            alert("‚ùå Selected bottle is empty!");
                        } else {
                            alert("‚ùå Colors don't match! Select same color or empty bottle.");
                        }
                        gameState.selectedTube = null;
                        renderBottles();
                    }
                } else {
                    gameState.selectedTube = null;
                    renderBottles();
                }
            }
        }

        function hasColorInBottle(bottleIndex) {
            const bottle = gameState.bottles[bottleIndex];
            return bottle.some(color => color !== 0);
        }

        function isBottleFull(bottleIndex) {
            const bottle = gameState.bottles[bottleIndex];
            return bottle.filter(color => color !== 0).length === 4;
        }

        function canMoveWater(from, to) {
            const fromBottle = gameState.bottles[from];
            const toBottle = gameState.bottles[to];
            
            const topColorFrom = getTopColor(fromBottle);
            if (topColorFrom === 0) return false;
            
            if (isBottleFull(to)) return false;
            
            const topColorTo = getTopColor(toBottle);
            
            return topColorTo === 0 || topColorFrom === topColorTo;
        }

        function getTopColor(bottle) {
            for (let i = 3; i >= 0; i--) {
                if (bottle[i] !== 0) {
                    return bottle[i];
                }
            }
            return 0;
        }

        function moveWater(from, to) {
            const fromBottle = gameState.bottles[from];
            const toBottle = gameState.bottles[to];
            
            const colorToMove = getTopColor(fromBottle);
            
            gameState.moveHistory.push({
                from: from,
                to: to,
                color: colorToMove,
                fromBottle: JSON.parse(JSON.stringify(fromBottle)),
                toBottle: JSON.parse(JSON.stringify(toBottle))
            });
            
            let moved = false;
            for (let i = 3; i >= 0; i--) {
                if (fromBottle[i] === colorToMove && !moved) {
                    fromBottle[i] = 0;
                    moved = true;
                }
            }
            
            for (let i = 0; i < 4; i++) {
                if (toBottle[i] === 0) {
                    toBottle[i] = colorToMove;
                    break;
                }
            }
            
            gameState.moves++;
            gameState.selectedTube = null;
            
            updateDisplay();
            renderBottles();
            
            checkWinCondition();
        }

        function isBottleComplete(bottle) {
            const colors = bottle.filter(color => color !== 0);
            if (colors.length !== 4) return false;
            
            const firstColor = colors[0];
            return colors.every(color => color === firstColor);
        }

        function checkWinCondition() {
            const allComplete = gameState.bottles.every(bottle => 
                bottle.every(color => color === 0) || 
                isBottleComplete(bottle)
            );
            
            if (allComplete) {
                clearInterval(gameState.timerInterval);
                levelComplete();
            }
        }

        function levelComplete() {
            if (!checkLogin()) return;
            
            const currentLevel = gameState.currentLevel;
            const isLevelAlreadyCompleted = gameState.completedLevels.has(currentLevel);
            
            gameState.completedLevels.add(currentLevel);
            
            if (!isLevelAlreadyCompleted) {
                gameState.coins += 2;
                gameState.totalCoinsEarned += 2;
                
                gameState.hints += 1;
                
                coinsEarnedSection.style.display = 'flex';
                alreadyCompletedModal.style.display = 'none';
            } else {
                coinsEarnedSection.style.display = 'none';
                alreadyCompletedModal.style.display = 'block';
            }
            
            saveGameData();
            
            setTimeout(() => {
                showVictoryModal();
            }, 500);
        }

        function showVictoryModal() {
            if (!checkLogin()) return;
            
            document.getElementById('finalMoves').textContent = gameState.moves;
            document.getElementById('finalTime').textContent = formatTime(gameState.timer);
            document.getElementById('victoryModal').style.display = 'flex';
        }

        function closeModalAndStartNextLevel() {
            closeModal();
            if (gameState.currentLevel < 30) {
                gameState.currentLevel++;
                gameState.currentLevelStarted = false;
                loadLevel(gameState.currentLevel);
            } else {
                alert("üéâ Congratulations! You've completed all 30 levels!");
            }
        }

        function updateDisplay() {
            movesElement.textContent = gameState.moves;
            coinsElement.textContent = gameState.coins;
            levelElement.textContent = gameState.currentLevel;
            hintsElement.textContent = gameState.hints;
            hintsCountElement.textContent = gameState.hints;
            undoCountElement.textContent = gameState.undoCount;
        }

        function startTimer() {
            clearInterval(gameState.timerInterval);
            gameState.timer = 0;
            gameState.timerInterval = setInterval(() => {
                gameState.timer++;
            }, 1000);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function darkenColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.max(0, (num >> 16) - amt);
            const G = Math.max(0, (num >> 8 & 0x00FF) - amt);
            const B = Math.max(0, (num & 0x0000FF) - amt);
            return `#${(0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1)}`;
        }

        // Game Controls
        function giveHint() {
            if (!checkLogin()) return;
            
            if (!gameState.currentLevelStarted) {
                alert("Please start the level first!");
                return;
            }
            
            if (gameState.hints > 0) {
                for (let i = 0; i < gameState.bottles.length; i++) {
                    for (let j = 0; j < gameState.bottles.length; j++) {
                        if (i !== j && canMoveWater(i, j)) {
                            const bottles = document.querySelectorAll('.tube');
                            bottles[i].style.boxShadow = '0 0 20px #00FF00';
                            bottles[j].style.boxShadow = '0 0 20px #00FF00';
                            
                            setTimeout(() => {
                                bottles[i].style.boxShadow = '';
                                bottles[j].style.boxShadow = '';
                            }, 2000);
                            
                            gameState.hints--;
                            updateDisplay();
                            saveGameData();
                            return;
                        }
                    }
                }
                alert('No valid moves found!');
            } else {
                if (confirm('No hints left! Watch Unity Ad for 3 hints?')) {
                    showRewarded('hints');
                }
            }
        }

        function undoMove() {
            if (!checkLogin()) return;
            
            if (!gameState.currentLevelStarted) {
                alert("Please start the level first!");
                return;
            }
            
            if (gameState.undoCount > 0) {
                if (gameState.moveHistory.length > 0) {
                    const lastMove = gameState.moveHistory.pop();
                    gameState.bottles[lastMove.from] = lastMove.fromBottle;
                    gameState.bottles[lastMove.to] = lastMove.toBottle;
                    gameState.moves--;
                    gameState.undoCount--;
                    updateDisplay();
                    renderBottles();
                    saveGameData();
                } else {
                    alert('No moves to undo!');
                }
            } else {
                if (confirm('No undo left! Watch Unity Ad for 3 undo?')) {
                    showRewarded('undo');
                }
            }
        }

        function restartLevel() {
            if (!checkLogin()) return;
            
            if (confirm('Restart current level? Your moves will reset.')) {
                loadLevel(gameState.currentLevel);
            }
        }

        // NEW: Rules Function
        function showRules() {
            if (!checkLogin()) return;
            
            document.getElementById('rulesModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('victoryModal').style.display = 'none';
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('signupModal').style.display = 'none';
            document.getElementById('userModal').style.display = 'none';
            document.getElementById('rulesModal').style.display = 'none';
        }

        // Firebase Auth Functions
        function showLogin() {
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('loginError').textContent = '';
        }

        function showSignup() {
            document.getElementById('signupModal').style.display = 'flex';
            document.getElementById('signupError').textContent = '';
            document.getElementById('signupSuccess').textContent = '';
        }

        async function signup() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            
            if (!name || !email || !password) {
                document.getElementById('signupError').textContent = 'Please fill all fields';
                return;
            }
            
            if (password.length < 6) {
                document.getElementById('signupError').textContent = 'Password must be at least 6 characters';
                return;
            }
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                await setDoc(doc(db, 'users', user.uid), {
                    name: name,
                    email: email,
                    gameData: {
                        coins: 0,
                        completedLevels: [],
                        totalCoinsEarned: 0,
                        currentLevel: 1,
                        hints: 5,
                        undoCount: 3,
                        gameStarted: false,
                        currentLevelStarted: false
                    },
                    createdAt: new Date()
                });
                
                document.getElementById('signupSuccess').textContent = 'Account created successfully!';
                setTimeout(() => {
                    closeModal();
                    updateAuthUI();
                    showGameScreen();
                    initGame();
                }, 1500);
            } catch (error) {
                document.getElementById('signupError').textContent = error.message;
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                document.getElementById('loginError').textContent = 'Please fill all fields';
                return;
            }
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeModal();
                updateAuthUI();
                showGameScreen();
                
                await loadUserDataFromFirebase();
            } catch (error) {
                document.getElementById('loginError').textContent = error.message;
            }
        }

        async function loadUserDataFromFirebase() {
            try {
                const userDoc = await getDoc(doc(db, 'users', auth.currentUser.uid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    loadGameDataFromFirebase(data);
                }
            } catch (error) {
                console.error('Error loading Firebase data:', error);
            }
        }

        async function logout() {
            try {
                await signOut(auth);
                updateAuthUI();
                closeModal();
                showLoginScreen();
                alert('Logged out successfully');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function showUserProfile() {
            if (!checkLogin()) return;
            
            const user = auth.currentUser;
            const profileName = document.getElementById('profileName');
            const profileEmail = document.getElementById('profileEmail');
            const profileAvatar = document.getElementById('profileAvatar');
            
            if (user) {
                profileName.textContent = user.displayName || user.email;
                profileEmail.textContent = user.email;
                profileAvatar.textContent = user.displayName ? 
                    user.displayName.charAt(0).toUpperCase() : 
                    user.email.charAt(0).toUpperCase();
            }
            
            document.getElementById('profileCoins').textContent = gameState.coins;
            document.getElementById('profileLevels').textContent = gameState.completedLevels.size;
            document.getElementById('profileHints').textContent = gameState.hints;
            
            document.getElementById('userModal').style.display = 'flex';
        }

        function updateAuthUI() {
            const user = auth.currentUser;
            const avatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const userEmail = document.getElementById('userEmail');
            
            if (user) {
                avatar.innerHTML = user.displayName ? 
                    user.displayName.charAt(0).toUpperCase() : 
                    user.email.charAt(0).toUpperCase();
                userName.textContent = user.displayName || user.email;
                userEmail.textContent = "Logged In";
            } else {
                avatar.innerHTML = '<i class="fas fa-user"></i>';
                userName.textContent = 'Please Login';
                userEmail.textContent = 'Login required';
            }
        }

        // Initialize Firebase auth listener
        onAuthStateChanged(auth, (user) => {
            updateAuthUI();
            if (user) {
                showGameScreen();
                loadUserDataFromFirebase();
            } else {
                showLoginScreen();
            }
        });

        // Make functions available globally
        window.gameState = gameState;
        window.giveHint = giveHint;
        window.undoMove = undoMove;
        window.restartLevel = restartLevel;
        window.showRules = showRules;
        window.closeModal = closeModal;
        window.closeModalAndStartNextLevel = closeModalAndStartNextLevel;
        window.showLogin = showLogin;
        window.showSignup = showSignup;
        window.login = login;
        window.signup = signup;
        window.logout = logout;
        window.showUserProfile = showUserProfile;
        window.selectLevel = selectLevel;
        window.loadLevel = loadLevel;
        window.updateDisplay = updateDisplay;
        window.saveGameData = saveGameData;
        window.enableGameControls = enableGameControls;
        window.disableGameControls = disableGameControls;

        // Initialize the game
        initGame();

        
    </script>
</body>
</html>